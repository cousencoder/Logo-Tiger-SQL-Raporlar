SELECT
CARİ.CODE AS [KODU],
CARİ.CITY AS [ŞEHİR],
CARİ.DEFINITION_ AS [ÜNVANI],
MLZ.NAME AS [ÜRÜN],
FAT.FICHENO as [FİŞ NO],
STL.DATE_ AS [TARİH],
CASE When stl.DISTDISC>0 THEN 'İsk Uyg.' ELSE 'Liste' end AS [DURUM],
STL.AMOUNT AS [MİKTAR],
ISNULL(STL.LINENET/NULLIF(STL.AMOUNT,0)) AS [SATIŞ FIYAT],
(SELECT TOP 1 PRICE FROM LG_025_01_STLINE WHERE STOCKREF = MLZ.LOGICALREF AND (TRCODE = 1 OR (TRCODE = 14 AND BILLED = 0)) AND LPRODSTAT = 0 AND LINETYPE = 0 ORDER BY DATE_ DESC) AS [Son Alış],
(STL.LINENET) as [SATIŞ TOPLAMI],
(STL.AMOUNT*(SELECT TOP 1 PRICE FROM LG_025_01_STLINE WHERE STOCKREF = MLZ.LOGICALREF AND (TRCODE = 1 OR (TRCODE = 14 AND BILLED = 0)) AND LPRODSTAT = 0 AND LINETYPE = 0 ORDER BY DATE_ DESC)) AS [ ALIŞ NET TOPLAM],

ISNULL(((STL.LINENET)/NULLIF(STL.AMOUNT*(SELECT TOP 1 PRICE FROM LG_025_01_STLINE WHERE STOCKREF = MLZ.LOGICALREF AND (TRCODE = 1 OR (TRCODE = 14 AND BILLED = 0)) AND LPRODSTAT = 0 AND LINETYPE = 0 ORDER BY DATE_ DESC),0 )-1),0) AS [KAR ORAN],

ISNULL(((STL.LINENET/STL.AMOUNT)/NULLIF(STL.PRICE,0)-1),0) [İSKONTO]





FROM 
LG_025_01_STLINE AS STL,
LG_025_CLCARD as CARİ,
LG_025_ITEMS AS MLZ,
LG_025_01_INVOICE AS FAT,
LG_025_PRCLIST AS PRC WHERE
STL.CLIENTREF = CARİ.LOGICALREF 
AND
STL.STOCKREF = MLZ.LOGICALREF 
AND
STL.INVOICEREF = FAT.LOGICALREF
AND
PRC.CARDREF = MLZ.LOGICALREF AND
(STL.TRCODE=8)AND STL.BILLED=1
